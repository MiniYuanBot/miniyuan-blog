---
// The <Header /> component creates a consistent HTML header.

import { siteConfig } from "@/config";
import TextLink from "./TextLink.astro";
import IconLink from "./IconLink.astro";

const HomeIcon = `<svg xmlns="http://www.w3.org/2000/svg " width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`;
const SearchIcon = `<svg xmlns="http://www.w3.org/2000/svg " width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>`;
const MenuIcon = `<svg xmlns="http://www.w3.org/2000/svg " width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>`;

const navLeft = { path: "/", label: siteConfig.title };
const navCenter = [
	{ path: "/blog", label: "Blog" },
	{ path: "/tags", label: "Tags" },
	{ path: "/links", label: "Links" },
	{ path: "/about", label: "About" },
];
const navRight = [
	{ path: "/", label: "Home", svg: HomeIcon },
	{ path: "/search", label: "Search", svg: SearchIcon },
];
---

<header-component
	class="sticky top-0 z-50 block border-b transition-all duration-300"
>
	<nav
		class="flex items-center justify-between h-16 mx-auto px-6 md:px-8 max-w-7xl"
	>
		<!-- Left: site title -->
		<div class="flex-1">
			<h2 class="m-0 text-[1.2rem] font-semibold">
				<a
					href={navLeft.path}
					class="text-[rgb(var(--black))] no-underline transition-colors duration-200 hover:text-[rgb(var(--gray-dark))] dark:hover:text-white"
				>
					{siteConfig.title}
				</a>
			</h2>
		</div>

		<!-- Center: main navigation - hidden on mobile -->
		<div class="hidden md:flex flex-1 justify-center gap-1">
			{
				navCenter.map((item) => (
					<TextLink href={item.path}>{item.label}</TextLink>
				))
			}
		</div>

		<!-- Right: icon links - hidden on mobile -->
		<div class="hidden md:flex flex-1 justify-end gap-1">
			{
				navRight.map(({ path, label, svg }) => (
					<IconLink href={path} label={label} svg={svg} />
				))
			}
		</div>

		<!-- Mobile: menu button -->
		<div class="md:hidden">
			<button
				id="toggleMenu"
				aria-label="Menu"
				class="flex p-2 text-[rgb(var(--black))] bg-transparent border-none rounded-md transition-colors duration-200 hover:bg-[rgba(var(--gray-light),1)] dark:hover:bg-[rgb(var(--gray-dark)/0.5)] dark:hover:text-white"
			>
				<span set:html={MenuIcon} class="w-6 h-6" />
			</button>
		</div>
	</nav>
</header-component>

<!-- Mobile Menu Template -->
<template id="mobileMenuTemplate">
	<div
		id="mobileMenuPortal"
		class="md:hidden fixed left-4 right-4 flex-col rounded-xl shadow-xl transition-all duration-500 overflow-hidden"
		style="top: 4.5rem; z-index: 40; max-height: 0; opacity: 0; visibility: hidden; pointer-events: none; padding: 0;"
	>
		<div class="p-2">
			<div class="flex flex-col">
				{
					navCenter.map((item, index) => (
						<TextLink
							href={item.path}
							isMobile
							mobileBackground="transparent"
							mobileHoverBackground="rgb(var(--gray-light))"
							delay={index * 50}
						>
							{item.label}
						</TextLink>
					))
				}
			</div>

			<div
				class="h-px bg-[hsl(var(--border-hsl)/0.4)] dark:bg-[hsl(var(--border-hsl)/0.2)] mx-2 my-1"
			>
			</div>

			<div class="flex gap-2 px-1 pb-1">
				{
					navRight.map(({ path, label, svg }, index) => (
						<IconLink
							href={path}
							label={label}
							svg={svg}
							isMobile
							mobileBackground="transparent"
							mobileHoverBackground="rgb(var(--gray-light))"
							delay={(index + navCenter.length) * 50}
						/>
					))
				}
			</div>
		</div>
	</div>
</template>

<script>
	class HeaderComponent extends HTMLElement {
		private mobileMenuPortal: HTMLElement | null = null;
		private menuButton: HTMLElement | null = null;
		private isMenuOpen = false;
		private preScrollY = 0;

		connectedCallback() {
			const template = document.getElementById(
				"mobileMenuTemplate",
			) as HTMLTemplateElement;
			if (template) {
				const clone = template.content.cloneNode(
					true,
				) as DocumentFragment;
				this.mobileMenuPortal =
					clone.getElementById("mobileMenuPortal");
				if (this.mobileMenuPortal)
					document.body.appendChild(this.mobileMenuPortal);
			}

			this.preScrollY = window.scrollY;
			this._updateScrollState(this.preScrollY);

			let ticking = false;
			window.addEventListener("scroll", () => {
				if (ticking) return;
				ticking = true;
				requestAnimationFrame(() => {
					const currentScrollY = window.scrollY;
					this.dataset.show = (
						currentScrollY < 350 || currentScrollY < this.preScrollY
					).toString();
					this._updateScrollState(currentScrollY);
					this.preScrollY = currentScrollY;
					ticking = false;
				});
			});

			this.menuButton = this.querySelector("#toggleMenu");
			this.menuButton?.addEventListener("click", (e) => {
				e.stopPropagation();
				this._toggleMenu();
			});

			this.mobileMenuPortal
				?.querySelectorAll("a")
				.forEach((link) =>
					link.addEventListener("click", () => this._toggleMenu()),
				);

			document.addEventListener("click", (e) => {
				if (
					this.isMenuOpen &&
					!this.contains(e.target as Node) &&
					!this.mobileMenuPortal?.contains(e.target as Node)
				) {
					this._toggleMenu();
				}
			});

			const observer = new MutationObserver(() => {
				if (this.isMenuOpen) this._updateMenuPosition();
			});
			observer.observe(this, {
				attributes: true,
				attributeFilter: ["data-show", "class"],
			});
		}

		private _toggleMenu() {
			this.isMenuOpen = !this.isMenuOpen;
			this.classList.toggle("expanded", this.isMenuOpen);

			if (!this.mobileMenuPortal) return;

			if (this.isMenuOpen) {
				this.mobileMenuPortal.style.visibility = "visible";
				this.mobileMenuPortal.style.pointerEvents = "auto";

				const height = this.mobileMenuPortal.scrollHeight;

				this.mobileMenuPortal.style.maxHeight = `${height}px`;
				this.mobileMenuPortal.style.opacity = "1";
				this.mobileMenuPortal.style.padding = "";
			} else {
				this.mobileMenuPortal.style.maxHeight = "0";
				this.mobileMenuPortal.style.opacity = "0";
				this.mobileMenuPortal.style.visibility = "hidden";
				this.mobileMenuPortal.style.pointerEvents = "none";
				this.mobileMenuPortal.style.padding = "0";
			}

			if (this.isMenuOpen) this._updateMenuPosition();
		}

		private _updateScrollState(scrollY: number) {
			const isScrolled = scrollY > 20;
			this.classList.toggle("is-scrolled", isScrolled);
			this.mobileMenuPortal?.classList.toggle("is-scrolled", isScrolled);
		}

		private _updateMenuPosition() {
			if (this.mobileMenuPortal) {
				this.mobileMenuPortal.style.top = `${this.getBoundingClientRect().bottom + 8}px`;
			}
		}

		disconnectedCallback() {
			this.mobileMenuPortal?.remove();
		}
	}

	customElements.define("header-component", HeaderComponent);
</script>

<style>
	header-component {
		background-color: hsl(var(--card-hsl));
		border-color: hsla(var(--border-hsl), 0.5);
	}

	header-component.is-scrolled {
		background-color: hsla(var(--card-hsl), 0.92);
		border-color: hsl(var(--border-hsl));
		box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
	}

	.dark header-component {
		border-color: hsla(var(--border-hsl), 0.3);
	}

	.dark header-component.is-scrolled {
		border-color: hsla(var(--border-hsl), 0.5);
	}

	header-component[data-show="false"]:not(.expanded) {
		transform: translateY(-100%);
	}

	header-component.expanded {
		transform: translateY(0) !important;
	}

	#mobileMenuPortal {
		background-color: hsl(var(--card-hsl));
		border: 1px solid hsla(var(--border-hsl), 0.5);
		transition:
			max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
			opacity 0.3s ease,
			padding 0.3s ease,
			visibility 0.3s ease;
		will-change: max-height, opacity;
	}

	#mobileMenuPortal.is-scrolled {
		background-color: hsla(var(--card-hsl), 0.92);
		border-color: hsl(var(--border-hsl));
	}

	.dark #mobileMenuPortal {
		background-color: hsl(var(--card-hsl));
		border-color: hsla(var(--border-hsl), 0.3);
	}

	.dark #mobileMenuPortal.is-scrolled {
		background-color: hsla(var(--card-hsl), 0.98);
		border-color: hsla(var(--border-hsl), 0.5);
	}

	@media (min-width: 768px) {
		#mobileMenuPortal {
			display: none !important;
		}
	}
</style>
