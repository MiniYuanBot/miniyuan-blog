---
// The <Header /> component creates a consistent HTML header.

import { headerConfig } from "@/config";
import { ThemeToggle } from "../ui";
import { Icon } from "../ui";
import TextLink from "./TextLink.astro";
import IconLink from "./IconLink.astro";
---

<header-component
	class="sticky top-0 z-50 block border-b border-border/50 transition-base bg-background/80"
>
	<nav class="flex-between h-16 mx-auto px-6 md:px-8 max-w-7xl">
		<!-- Left: site title -->
		<div class="flex-1">
			<h2 class="m-0 text-xl font-semibold">
				<a href={headerConfig.left.link} class="text-foreground no-underline transition-colors hover:text-accent">
					{headerConfig.left.title}
				</a>
			</h2>
		</div>

		<!-- Center: main navigation - hidden on mobile -->
		<div class="hidden md:flex flex-1 justify-center gap-1">
			{
				headerConfig.center.map((item) => (
					<TextLink href={item.link}>{item.title}</TextLink>
				))
			}
		</div>

		<!-- Right: icon links - hidden on mobile -->
		<div class="hidden md:flex flex-1 justify-end gap-1">
			{
				headerConfig.right.map(({ link, title, icon }) => (
					<IconLink href={link} label={title} icon={icon} />
				))
			}
			<ThemeToggle />
		</div>

		<!-- Mobile: menu button -->
		<div class="md:hidden flex justify-end gap-1">
			<ThemeToggle />
			<button id="toggleMenu" aria-label="Menu" class="icon-button-base">
				<Icon name="menu" class="icon-base" />
			</button>
		</div>
	</nav>
</header-component>

<!-- Mobile Menu Template -->
<template id="mobileMenuTemplate">
	<div
		id="mobileMenuPortal"
		class="md:hidden fixed left-4 right-4 top-[4.5rem] z-40
            flex flex-col rounded-xl shadow-md transition-base
            max-h-0 opacity-0 invisible pointer-events-none p-0"
	>
		<div class="p-2 bg-card border border-border/50 rounded-xl">
			<div class="flex flex-col">
				{
					headerConfig.center.map((item, index) => (
						<TextLink href={item.link} isMobile delay={index * 50}>
							{item.title}
						</TextLink>
					))
				}
			</div>

			<div class="h-px bg-gray-light mx-2 my-1"></div>

			<div class="flex gap-2 px-1 pb-1">
				{
					headerConfig.right.map(({ link, title, icon }, index) => (
						<IconLink
							href={link}
							label={title}
							icon={icon}
							isMobile
							delay={(index + headerConfig.center.length) * 50}
						/>
					))
				}
			</div>
		</div>
	</div>
</template>

<script>
	class HeaderComponent extends HTMLElement {
		private portal: HTMLElement | null = null;
		private isOpen = false;
		private lastScroll = 0;
		private abortController: AbortController | null = null;
		private observer: MutationObserver | null = null;

		connectedCallback() {
			// create AbortController to control cleaning stuff
			this.abortController = new AbortController();
			const { signal } = this.abortController;

			const template = document.getElementById(
				"mobileMenuTemplate",
			) as HTMLTemplateElement | null;
			if (template) {
				const clone = template.content.cloneNode(
					true,
				) as DocumentFragment;
				this.portal = clone.getElementById("mobileMenuPortal");
				if (this.portal) document.body.appendChild(this.portal);
			}

			this.lastScroll = window.scrollY;
			this._updateScroll(window.scrollY);

			window.addEventListener(
				"scroll",
				() => {
					const current = window.scrollY;
					this.dataset.show = (
						current < 350 || current < this.lastScroll
					).toString();
					this._updateScroll(current);
					this.lastScroll = current;
				},
				{ passive: true, signal },
			);

			this.querySelector("#toggleMenu")?.addEventListener(
				"click",
				(e) => {
					e.stopPropagation();
					this._toggleMenu();
				},
				{ signal },
			);

			// close if click inside link
			this.portal?.querySelectorAll("a").forEach((link) => {
				link.addEventListener("click", () => this._toggleMenu(), {
					signal,
				});
			});

			// close if click outside
			document.addEventListener(
				"click",
				(e) => {
					if (
						this.isOpen &&
						!this.contains(e.target as Node) &&
						!this.portal?.contains(e.target as Node)
					) {
						this._toggleMenu();
					}
				},
				{ signal },
			);

			this.observer = new MutationObserver(
				() => this.isOpen && this._positionMenu(),
			);
			this.observer.observe(this, {
				attributes: true,
				attributeFilter: ["data-show", "class"],
			});
		}

		private _updateScroll(y: number) {
			const scrolled = y > 20;
			this.classList.toggle("is-scrolled", scrolled);
			this.portal?.classList.toggle("is-scrolled", scrolled);
		}

		private _toggleMenu() {
			this.isOpen = !this.isOpen;
			this.classList.toggle("expanded", this.isOpen);

			if (!this.portal) return;

			if (this.isOpen) {
				Object.assign(this.portal.style, {
					visibility: "visible",
					pointerEvents: "auto",
					maxHeight: `${this.portal.scrollHeight}px`,
					opacity: "1",
				});
				this._positionMenu();
			} else {
				Object.assign(this.portal.style, {
					maxHeight: "0",
					opacity: "0",
					visibility: "hidden",
					pointerEvents: "none",
					padding: "0",
				});
			}
		}

		private _positionMenu() {
			if (this.portal) {
				this.portal.style.top = `${this.getBoundingClientRect().bottom + 8}px`;
			}
		}

		disconnectedCallback() {
			// clean the listen stuff
			this.abortController?.abort();
			this.observer?.disconnect();
			this.portal?.remove();
		}
	}

	customElements.define("header-component", HeaderComponent);
</script>

<style>
	header-component.is-scrolled {
		@apply "bg-card/92 border-border/92 shadow-md";
	}

	header-component[data-show="false"]:not(.expanded) {
		@apply "translate-y-[-100%]";
	}

	header-component.expanded {
		transform: translateY(0) !important;
	}

	#mobileMenuPortal {
		@apply transition-base duration-500;
	}

	#mobileMenuPortal.is-scrolled .p-2 {
		@apply bg-card/92 border-border/92;
	}

	@media (min-width: 768px) {
		#mobileMenuPortal {
			display: none !important;
		}
	}
</style>
