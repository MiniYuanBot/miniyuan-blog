---
// The <Header /> component creates a consistent HTML header.

import { siteConfig } from "@/config";
import TextLink from "./TextLink.astro";
import IconLink from "./IconLink.astro";

const HomeIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`;
const SearchIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>`;
const MenuIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>`;

const navLeft = { path: "/", label: siteConfig.title };
const navCenter = [
	{ path: "/blog", label: "Blog" },
	{ path: "/tags", label: "Tags" },
	{ path: "/links", label: "Links" },
	{ path: "/about", label: "About" },
];
const navRight = [
	{ path: "/", label: "Home", svg: HomeIcon },
	{ path: "/search", label: "Search", svg: SearchIcon },
];
---

<header-component
	class="sticky top-0 z-50 block border-b transition-all duration-300"
>
	<nav
		class="flex items-center justify-between h-16 mx-auto px-6 md:px-8 max-w-7xl"
	>
		<!-- Left: site title -->
		<div class="flex-1">
			<h2 class="m-0 text-xl font-semibold">
				<a
					href={navLeft.path}
					class="text-[rgb(var(--black))] no-underline transition-colors duration-200 ease-out hover:text-[rgb(var(--gray-dark))] dark:hover:text-white"
				>
					{siteConfig.title}
				</a>
			</h2>
		</div>

		<!-- Center: main navigation - hidden on mobile -->
		<div class="hidden md:flex flex-1 justify-center gap-1">
			{
				navCenter.map((item) => (
					<TextLink href={item.path}>{item.label}</TextLink>
				))
			}
		</div>

		<!-- Right: icon links - hidden on mobile -->
		<div class="hidden md:flex flex-1 justify-end gap-1">
			{
				navRight.map(({ path, label, svg }) => (
					<IconLink href={path} label={label} svg={svg} />
				))
			}
		</div>

		<!-- Mobile: menu button -->
		<div class="md:hidden">
			<button
				id="toggleMenu"
				aria-label="Menu"
				class="flex p-2 text-[rgb(var(--black))] bg-transparent border-none rounded-md transition-colors duration-200 ease-out hover:bg-[hsl(var(--muted-hsl))] dark:hover:bg-[rgb(var(--gray-dark)/0.5)] dark:hover:text-white"
			>
				<span set:html={MenuIcon} class="w-6 h-6" />
			</button>
		</div>
	</nav>
</header-component>

<!-- Mobile Menu Template -->
<template id="mobileMenuTemplate">
	<div
		id="mobileMenuPortal"
		class="md:hidden fixed left-4 right-4 flex-col gap-1 p-2 rounded-xl border-none shadow-xl transition-all duration-300 opacity-0 invisible pointer-events-none"
		style="top: 4.5rem; z-index: 40;"
	>
		<div class="flex flex-col">
			{
				navCenter.map((item, index) => (
					<TextLink
						href={item.path}
						isMobile
						style={`animation-delay: ${index * 50}ms`}
					>
						{item.label}
					</TextLink>
				))
			}
		</div>

		<div
			class="mobile-menu-divider h-px bg-[hsl(var(--border-hsl)/0.4)] dark:bg-[hsl(var(--border-hsl)/0.2)] mx-2 my-1"
		>
		</div>

		<div class="flex gap-2 px-1 pb-1">
			{
				navRight.map(({ path, label, svg }, index) => (
					<IconLink
						href={path}
						label={label}
						svg={svg}
						isMobile
						style={`animation-delay: ${(index + navCenter.length) * 50}ms`}
					/>
				))
			}
		</div>
	</div>
</template>

<script>
	class HeaderComponent extends HTMLElement {
		private mobileMenuPortal: HTMLElement | null = null;
		private menuButton: HTMLElement | null = null;
		private isMenuOpen = false;
		private preScrollY = 0;

		connectedCallback() {
			const template = document.getElementById(
				"mobileMenuTemplate",
			) as HTMLTemplateElement;
			if (template) {
				const clone = template.content.cloneNode(
					true,
				) as DocumentFragment;
				this.mobileMenuPortal = clone.querySelector(
					"#mobileMenuPortal",
				) as HTMLElement;
				if (this.mobileMenuPortal)
					document.body.appendChild(this.mobileMenuPortal);
			}

			this.preScrollY = window.scrollY;
			this._updateScrollState(this.preScrollY);

			let ticking = false;
			window.addEventListener("scroll", () => {
				if (ticking) return;
				ticking = true;
				requestAnimationFrame(() => {
					const currentScrollY = window.scrollY;
					this.dataset.show = (
						currentScrollY < 350 || currentScrollY < this.preScrollY
					).toString();
					this._updateScrollState(currentScrollY);
					this.preScrollY = currentScrollY;
					ticking = false;
				});
			});

			this.menuButton = this.querySelector("#toggleMenu");
			this.menuButton?.addEventListener("click", (e) => {
				e.stopPropagation();
				this._toggleMenu();
			});

			// 点击链接关闭菜单 - 使用更通用的选择器
			this.mobileMenuPortal
				?.querySelectorAll("a")
				.forEach((link) =>
					link.addEventListener("click", () => this._toggleMenu()),
				);

			document.addEventListener("click", (e) => {
				if (
					this.isMenuOpen &&
					!this.contains(e.target as Node) &&
					!this.mobileMenuPortal?.contains(e.target as Node)
				) {
					this._toggleMenu();
				}
			});

			const observer = new MutationObserver(() => {
				if (this.isMenuOpen) this._updateMenuPosition();
			});
			observer.observe(this, {
				attributes: true,
				attributeFilter: ["data-show", "class"],
			});
		}

		private _toggleMenu() {
			this.isMenuOpen = !this.isMenuOpen;
			this.classList.toggle("expanded", this.isMenuOpen);

			if (!this.mobileMenuPortal) return;

			const [add, remove] = this.isMenuOpen
				? [
						["opacity-100", "visible", "pointer-events-auto"],
						["opacity-0", "invisible", "pointer-events-none"],
					]
				: [
						["opacity-0", "invisible", "pointer-events-none"],
						["opacity-100", "visible", "pointer-events-auto"],
					];

			this.mobileMenuPortal.classList.remove(...remove);
			this.mobileMenuPortal.classList.add(...add);

			if (this.isMenuOpen) this._updateMenuPosition();
		}

		private _updateScrollState(scrollY: number) {
			const isScrolled = scrollY > 20;
			this.classList.toggle("is-scrolled", isScrolled);
			this.mobileMenuPortal?.classList.toggle("is-scrolled", isScrolled);
		}

		private _updateMenuPosition() {
			if (this.mobileMenuPortal) {
				this.mobileMenuPortal.style.top = `${this.getBoundingClientRect().bottom + 8}px`;
			}
		}

		disconnectedCallback() {
			this.mobileMenuPortal?.remove();
		}
	}

	customElements.define("header-component", HeaderComponent);
</script>

<style>
	/* ===== Header ===== */
	header-component {
		background-color: hsl(var(--card-hsl));
		border-color: transparent;
		transition:
			transform 0.3s ease,
			background-color 0.3s ease,
			border-color 0.3s ease,
			box-shadow 0.3s ease;
	}

	header-component.is-scrolled {
		background-color: hsl(var(--card-hsl) / 0.8);
		backdrop-filter: blur(4px);
		border-color: hsl(var(--border-hsl));
		box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
	}

	.dark header-component.is-scrolled {
		background-color: hsl(var(--card-hsl) / 0.85);
		border-color: hsl(var(--border-hsl) / 0.2);
	}

	header-component[data-show="false"]:not(.expanded) {
		transform: translateY(-100%);
	}

	header-component.expanded {
		transform: translateY(0) !important;
	}

	/* ===== Mobile Menu Portal ===== */
	#mobileMenuPortal {
		background-color: hsl(var(--card-hsl) / 0.88);
		backdrop-filter: blur(12px) saturate(180%);
		border-color: hsl(var(--border-hsl) / 0.6);
		box-shadow:
			0 20px 25px -5px rgb(0 0 0 / 0.1),
			0 8px 10px -6px rgb(0 0 0 / 0.1);
		max-height: calc(100vh - 6rem);
		overflow-y: auto;
		transition:
			opacity 0.3s ease,
			visibility 0.3s ease,
			top 0.1s ease;
	}

	#mobileMenuPortal.is-scrolled {
		background-color: hsl(var(--card-hsl) / 0.82);
		backdrop-filter: blur(16px) saturate(200%);
		border-color: hsl(var(--border-hsl));
	}

	.dark #mobileMenuPortal {
		background-color: hsl(var(--card-hsl) / 0.85);
		border-color: hsl(var(--border-hsl) / 0.2);
	}

	.dark #mobileMenuPortal.is-scrolled {
		background-color: hsl(var(--card-hsl) / 0.82);
	}

	.mobile-menu-divider {
		transition: background-color 0.2s ease;
	}

	@media (min-width: 768px) {
		#mobileMenuPortal {
			display: none !important;
		}
	}
</style>
